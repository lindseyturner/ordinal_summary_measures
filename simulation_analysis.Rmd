---
title: "Simulation Results"
author: "Lindsey Turner"
date: '`r Sys.Date()`'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
library(tidyverse)
library(LaplacesDemon)
library(spatstat.utils)
library(cowplot)
library(RColorBrewer)
```


\textbf{Simulation setting 1:} Null Effect

pc = pt = c(0.2, 0.2, 0.2, 0.2, 0.2)


\textbf{Simulation setting 2:} Constant Risk Difference Low

pc = c(0.2, 0.2, 0.2, 0.2, 0.2)

pt = c(0.26, 0.2, 0.2, 0.2, 0.14)


\textbf{Simulation setting 3:} Constant Risk Difference High

pc = c(0.2, 0.2, 0.2, 0.2, 0.2)

pt = c(0.27, 0.2, 0.2, 0.2, 0.13)

\textbf{Simulation setting 4:} Constant Relative Risk Low

pc = c(0.2, 0.2, 0.2, 0.2, 0.2)

pt = c(0.225, 0.225, 0.225, 0.225, 0.10)

\textbf{Simulation setting 5:} Constant Relative Risk High

pc = c(0.2, 0.2, 0.2, 0.2, 0.2)

pt = c(0.23, 0.23, 0.23, 0.23, 0.08)


\textbf{Simulation setting 6:} Low Proportional Odds 

pc = c(0.2, 0.2, 0.2, 0.2, 0.2)

pt = c(0.255, 0.222, 0.195, 0.173, 0.154)

beta = 0.31


\textbf{Simulation setting 7:} High Proportional Odds 

pc = c(0.2, 0.2, 0.2, 0.2, 0.2)

pt = c(0.269, 0.226, 0.193, 0.167, 0.145)

beta = 0.39

\textbf{Simulation setting 8:} 15% Reduction in 3-5, Rest to 1

pc = c(0.2, 0.2, 0.2, 0.2, 0.2)

pt = c(0.29, 0.2, 0.17, 0.17, 0.17)

\textbf{Simulation setting 9:} 25% Reduction in 3-5, Rest to 2

pc = c(0.2, 0.2, 0.2, 0.2, 0.2)

pt = c(0.2, 0.35, 0.15, 0.15, 0.15)



\newpage 



```{r, echo = F}
#make plot of the various scenarios

#top left corner - stacked bar chart of the various scenarios 
pc <- rep(0.2, 5)
pc1 <- pc
pt1 <- pc 
# low constant risk difference
pt2 <- c(0.26, 0.2, 0.2, 0.2, 0.14)
# high constant risk difference 
pt3 <- c(0.27, 0.2, 0.2, 0.2, 0.13)
# low RR
pt4 <- c(0.225, 0.225, 0.225, 0.225, 0.10)
# high RR 
pt5 <- c(0.23, 0.23, 0.23, 0.23, 0.08)
# low PO
beta1 <- log(1.37)
pt6 <- c(invlogit(logit(pc1[1]) + beta1),
         invlogit(logit(pc1[1] + pc1[2]) + beta1) - invlogit(logit(pc1[1]) + beta1),
         invlogit(logit(pc1[1] + pc1[2] + pc1[3]) + beta1) - invlogit(logit(pc1[1] + pc1[2]) + beta1),
         invlogit(logit(pc1[1] + pc1[2] + pc1[3] + pc1[4]) + beta1) - invlogit(logit(pc1[1] + pc1[2] + pc1[3]) + beta1),
         1 - invlogit(logit(pc1[1] + pc1[2] + pc1[3] + pc1[4]) + beta1))

# high PO 
beta2 <- log(1.47)
pt7 <- c(invlogit(logit(pc1[1]) + beta2),
         invlogit(logit(pc1[1] + pc1[2]) + beta2) - invlogit(logit(pc1[1]) + beta2),
         invlogit(logit(pc1[1] + pc1[2] + pc1[3]) + beta2) - invlogit(logit(pc1[1] + pc1[2]) + beta2),
         invlogit(logit(pc1[1] + pc1[2] + pc1[3] + pc1[4]) + beta2) - invlogit(logit(pc1[1] + pc1[2] + pc1[3]) + beta2),
         1 - invlogit(logit(pc1[1] + pc1[2] + pc1[3] + pc1[4]) + beta2))
# 20% red in last 3, rest to 1 
pt8 <- c(0.29, 0.2, 0.17, 0.17, 0.17)
# 25% red in last 3, rest to 2
pt9 <- c(0.2, 0.35, 0.15, 0.15, 0.15)

scenarios1 <- as.data.frame(rbind(pc, pt1, pt2, pt3, pt4, pt5, pt6, pt7, pt8, pt9))
colnames(scenarios1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
scenarios1$Scenario <- c("Control", "Null", "Low RD", "High RD", "Low RR", "High RR", "Low PO", "High PO", 
                         "NP 1", "NP 2")

p1_even <- scenarios1  %>%
  mutate(Scenario = factor(Scenario, levels = c("Control", "Null", "Low PO", "High PO", "Low RD", "High RD", 
                                                "Low RR", "High RR", 
                                                 "NP 1", "NP 2"))) %>% 
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "Proportion") %>% 
  mutate(Outcome = factor(Outcome, levels = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"))) %>%
  ggplot(aes(x = Scenario, y = Proportion, fill = Outcome)) + geom_bar(stat = "identity") + 
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme_bw(base_size = 10) + scale_fill_brewer(palette = "Blues") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14)) 

rd1 <- cumsum(pt1) - cumsum(pc)
rd2 <- cumsum(pt2) - cumsum(pc)
rd3 <- cumsum(pt3) - cumsum(pc)
rd4 <- cumsum(pt4) - cumsum(pc) 
rd5 <- cumsum(pt5) - cumsum(pc) 
rd6 <- cumsum(pt6) - cumsum(pc) 
rd7 <- cumsum(pt7) - cumsum(pc) 
rd8 <- cumsum(pt8) - cumsum(pc) 
rd9 <- cumsum(pt9) - cumsum(pc) 

risk_dif1 <- as.data.frame(rbind(rd1, rd2, rd3, rd4, rd5, rd6, rd7, rd8, rd9))
colnames(risk_dif1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
risk_dif1$Scenario <- c("Null", "Low RD", "High RD", "Low RR", "High RR", "Low PO", "High PO", 
                         "NP 1", "NP 2")

p2 <- risk_dif1 %>% filter(Scenario != "Null") %>%
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "RD") %>% 
  filter(Outcome != "Death") %>%
  mutate(Outcome = factor(Outcome, levels = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization")),
         Scenario = factor(Scenario, levels = c("Low PO", "High PO", "Low RD", "High RD", 
                                                "Low RR", "High RR", 
                                                "NP 1", "NP 2")))  %>%
  group_by(Scenario) %>%
  ggplot(aes(x = Outcome, y = RD, color = Scenario, group = Scenario, linetype = Scenario)) + 
  geom_line(linewidth = 1) + geom_point(show.legend = F) +
  theme_bw(base_size = 10) + ylab("Cumulative Risk Difference") + 
  scale_linetype_manual(values = c(rep(c("longdash", "solid"), 4))) +
  scale_color_manual(values = c(rep(brewer.pal(8, "Paired")[2], 2), 
                                rep(brewer.pal(8, "Paired")[4], 2), rep(brewer.pal(8, "Paired")[6], 2),
                                rep(brewer.pal(8, "Paired")[8], 2))) + 
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14))  + 
  scale_x_discrete(labels = c("Nothing" = "1|2",
                              "Hypoxemia" = "2|3", 
                              "ED Visit" = "3|4", 
                              "Hopsitalization" = "4|5"))

#c(brewer.pal(10, "Paired")[10], brewer.pal(8, "Paired")))


rr1 <- cumsum(pt1) / cumsum(pc)
rr2 <- cumsum(pt2) / cumsum(pc)
rr3 <- cumsum(pt3) / cumsum(pc)
rr4 <- cumsum(pt4) / cumsum(pc)
rr5 <- cumsum(pt5) / cumsum(pc) 
rr6 <- cumsum(pt6) / cumsum(pc) 
rr7 <- cumsum(pt7) / cumsum(pc) 
rr8 <- cumsum(pt8) / cumsum(pc) 
rr9 <- cumsum(pt9) / cumsum(pc)

rel_risk1 <- as.data.frame(rbind(rr1, rr2, rr3, rr4, rr5, rr6, rr7, rr8, rr9))
colnames(rel_risk1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
rel_risk1$Scenario <- c("Null", "Low RD", "High RD", "Low RR", "High RR", "Low PO", "High PO", 
                         "NP 1", "NP 2")

p3 <- rel_risk1 %>% filter(Scenario != "Null") %>%
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "RR") %>% 
  filter(Outcome != "Death")  %>%
  mutate(Outcome = factor(Outcome, levels = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization")),
         Scenario = factor(Scenario, levels = c("Low PO", "High PO", "Low RD", "High RD", 
                                                "Low RR", "High RR", 
                                                "NP 1", "NP 2")))  %>%
  group_by(Scenario) %>% 
  ggplot(aes(x = Outcome, y = RR, color = Scenario, group = Scenario, linetype = Scenario)) + 
  geom_line(linewidth = 1) + geom_point(show.legend = F) +
  theme_bw(base_size = 10) + ylab("Cumulative Relative Risk") + 
  scale_linetype_manual(values = c(rep(c("longdash", "solid"), 4))) +
  scale_color_manual(values = c(rep(brewer.pal(8, "Paired")[2], 2), 
                                rep(brewer.pal(8, "Paired")[4], 2), rep(brewer.pal(8, "Paired")[6], 2),
                                rep(brewer.pal(8, "Paired")[8], 2))) + 
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14)) + 
  scale_x_discrete(labels = c("Nothing" = "\u2264 1",
                              "Hypoxemia" = "\u2264 2", 
                              "ED Visit" = "\u2264 3", 
                              "Hopsitalization" = "\u2264 4"))

#rr greater than or equal to 
rr1 <- revcumsum(pc) / revcumsum(pt1)
rr2 <- revcumsum(pc) / revcumsum(pt2)
rr3 <- revcumsum(pc) / revcumsum(pt3)
rr4 <- revcumsum(pc) / revcumsum(pt4)
rr5 <- revcumsum(pc) / revcumsum(pt5)
rr6 <- revcumsum(pc) / revcumsum(pt6) 
rr7 <- revcumsum(pc) / revcumsum(pt7)
rr8 <- revcumsum(pc) / revcumsum(pt8) 
rr9 <- revcumsum(pc) / revcumsum(pt9)

rel_risk1 <- as.data.frame(rbind(rr1, rr2, rr3, rr4, rr5, rr6, rr7, rr8, rr9))
colnames(rel_risk1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
rel_risk1$Scenario <- c("Null", "Low RD", "High RD", "Low RR", "High RR", "Low PO", "High PO", 
                         "NP 1", "NP 2")

p3ge <- rel_risk1 %>% filter(Scenario != "Null") %>%
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "RR") %>% 
  filter(Outcome != "Nothing")  %>%
  mutate(Outcome = factor(Outcome, levels = c("Hypoxemia", "ED Visit", "Hopsitalization", "Death")),
         Scenario = factor(Scenario, levels = c("Low PO", "High PO", "Low RD", "High RD", 
                                                "Low RR", "High RR", 
                                                "NP 1", "NP 2")))  %>%
  group_by(Scenario) %>% 
  ggplot(aes(x = Outcome, y = RR, color = Scenario, group = Scenario, linetype = Scenario)) + 
  geom_line(linewidth = 1) + geom_point(show.legend = F) +
  theme_bw(base_size = 10) + ylab("Cumulative Relative Risk") + 
  scale_linetype_manual(values = c(rep(c("longdash", "solid"), 4))) +
  scale_color_manual(values = c(rep(brewer.pal(8, "Paired")[2], 2), 
                                rep(brewer.pal(8, "Paired")[4], 2), rep(brewer.pal(8, "Paired")[6], 2),
                                rep(brewer.pal(8, "Paired")[8], 2))) + 
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14)) + 
  scale_x_discrete(labels = c("Hypoxemia" = "\u2265 2", 
                              "ED Visit" = "\u2265 3", 
                              "Hopsitalization" = "\u2265 4", 
                              "Death" = "\u2265 5"))



or1 <- (cumsum(pt1)/ (1- cumsum(pt1))) / (cumsum(pc) / (1 - cumsum(pc)))
or2 <- (cumsum(pt2)/ (1- cumsum(pt2))) / (cumsum(pc) / (1 - cumsum(pc)))
or3 <- (cumsum(pt3)/ (1- cumsum(pt3))) / (cumsum(pc) / (1 - cumsum(pc)))
or4 <- (cumsum(pt4)/ (1- cumsum(pt4))) / (cumsum(pc) / (1 - cumsum(pc)))
or5 <- (cumsum(pt5)/ (1- cumsum(pt5))) / (cumsum(pc) / (1 - cumsum(pc)))
or6 <- (cumsum(pt6)/ (1- cumsum(pt6))) / (cumsum(pc) / (1 - cumsum(pc)))
or7 <- (cumsum(pt7)/ (1- cumsum(pt7))) / (cumsum(pc) / (1 - cumsum(pc)))
or8 <- (cumsum(pt8)/ (1- cumsum(pt8))) / (cumsum(pc) / (1 - cumsum(pc)))
or9 <- (cumsum(pt9)/ (1- cumsum(pt9))) / (cumsum(pc) / (1 - cumsum(pc)))

odds_ratio1 <- as.data.frame(rbind(or1, or2, or3, or4, or5, or6, or7, or8, or9))
colnames(odds_ratio1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
odds_ratio1$Scenario <- c("Null", "Low RD", "High RD", "Low RR", "High RR", "Low PO", "High PO", 
                         "NP 1", "NP 2")

p4 <- odds_ratio1 %>% filter(Scenario != "Null") %>%
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "OR") %>% 
  filter(Outcome != "Death") %>%
  mutate(Outcome = factor(Outcome, levels = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization")),
         Scenario = factor(Scenario, levels = c("Low PO", "High PO", "Low RD", "High RD", 
                                                "Low RR", "High RR", 
                                                "NP 1", "NP 2")))  %>%
  group_by(Scenario) %>%
  ggplot(aes(x = Outcome, y = OR, color = Scenario, group = Scenario, linetype = Scenario)) +
  geom_line(linewidth = 1) + geom_point(show.legend = F) +
  theme_bw(base_size = 10) + ylab("Cumulative Odds Ratio") + 
  scale_linetype_manual(values = c(rep(c("longdash", "solid"), 4))) +
  scale_color_manual(values = c(rep(brewer.pal(8, "Paired")[2], 2), 
                                rep(brewer.pal(8, "Paired")[4], 2), rep(brewer.pal(8, "Paired")[6], 2),
                                rep(brewer.pal(8, "Paired")[8], 2))) + 
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14))  + 
  scale_x_discrete(labels = c("Nothing" = "1|2",
                              "Hypoxemia" = "2|3", 
                              "ED Visit" = "3|4", 
                              "Hopsitalization" = "4|5"))

legend <- get_legend(
  # create some space to the left of the legend
  p2 + theme(legend.key.size=unit(2.5,"lines")))

library(cowplot)
plots <- plot_grid(p4+ theme(legend.position="none"), p2+ theme(legend.position="none"), 
                   p3+ theme(legend.position="none"),
                   p3ge + theme(legend.position = "none"), labels = c("A", "B", "C", "D"))

plot_grid(plots, legend, rel_widths = c(3, 0.5))

#ggsave("simulation_scenarios1_040725.png", height = 8, width = 8, dpi = 600)


```


```{r, echo = FALSE}
setwd("~/Documents/Dissertation/Paper 1/Simulation_040725/")

# read in the data 
results1 <- rbind(as.data.frame(readRDS("results_array_040725_1.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_2.rds"))[1:1000,])
results1$Scenario <- "Null"
results2 <- rbind(as.data.frame(readRDS("results_array_040725_3.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_4.rds"))[1:1000,])
results2$Scenario <- "Low Constant RD"
results3 <- rbind(as.data.frame(readRDS("results_array_040725_5.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_6.rds"))[1:1000,])
results3$Scenario <- "High Constant RD"
results4 <- rbind(as.data.frame(readRDS("results_array_040725_7.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_8.rds"))[1:1000,])
results4$Scenario <- "Low Constant RR"
results5 <- rbind(as.data.frame(readRDS("results_array_040725_9.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_10.rds"))[1:1000,])
results5$Scenario <- "High Constant RR"
results6 <- rbind(as.data.frame(readRDS("results_array_040725_11.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_12.rds"))[1:1000,])
results6$Scenario <- "Low PO"
results7 <- rbind(as.data.frame(readRDS("results_array_040725_13.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_14.rds"))[1:1000,])
results7$Scenario <- "High PO"
results8 <- rbind(as.data.frame(readRDS("results_array_040725_15.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_16.rds"))[1:1000,])
results8$Scenario <- "15% red 3-5, rest to 1"
results9 <- rbind(as.data.frame(readRDS("results_array_040725_17.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_18.rds"))[1:1000,])
results9$Scenario <- "25% red 3-5, rest to 2"


```



```{r, echo = F}
# for paper
results_all <- rbind(results1, results2, results3, results4, results5, results6, results7, results8, results9)

results_all$Scenario <- factor(results_all$Scenario, levels = c("Null", "Low Constant RD", "High Constant RD",
                                                                "Low Constant RR", "High Constant RR",
                                                                "Low PO", "High PO", "15% red 3-5, rest to 1",
                                                                "25% red 3-5, rest to 2"))

results_all_extra <- results_all %>% separate(Frequentist_NB_CI, c("Freq_NB_Lower", "Freq_NB_Upper"), ";") 
results_all_extra$Freq_NB_Lower <- gsub("\\[", "", results_all_extra$Freq_NB_Lower)
results_all_extra$Freq_NB_Upper <- gsub("\\]", "", results_all_extra$Freq_NB_Upper)

results_all_extra %>% mutate_if(is.character, as.numeric) %>% group_by(Scenario) %>%
  dplyr::summarize(PO = round(sum((OR_CI_PO1 > 1 & 
                          OR_CI_PO2 > 1) |  (OR_CI_PO1 < 1 & 
                          OR_CI_PO2 < 1), na.rm = T)/
                      sum(!is.na(OR_CI_PO1)), 2),
            NB = round(sum((Freq_NB_Lower > 0 & Freq_NB_Upper > 0) | (Freq_NB_Lower < 0 & Freq_NB_Upper < 0))/
                                    sum(!is.na(Freq_NB_Lower)), 2),
            AOR = round(sum((`unweighted_OR_CI_PPO.2.5%` > 1 & 
                          `unweighted_OR_CI_PPO.97.5%` > 1) | (`unweighted_OR_CI_PPO.2.5%` < 1 & 
                          `unweighted_OR_CI_PPO.97.5%` < 1), na.rm = T)/
                      sum(!is.na(`unweighted_OR_CI_PPO.2.5%`)), 2),
            wOR = round(sum((`weighted_log_OR_both_CI_PPO.2.5%` > 0 & 
                          `weighted_log_OR_both_CI_PPO.97.5%` > 0) | (`weighted_log_OR_both_CI_PPO.2.5%` < 0 &
                          `weighted_log_OR_both_CI_PPO.97.5%` < 0) , na.rm = T)/
                      sum(!is.na(`weighted_log_OR_both_CI_PPO.2.5%`)), 2),
            wOR_overall = round(sum((`weighted_log_OR_both_ov_CI_PPO.2.5%` > 0 & 
                          `weighted_log_OR_both_ov_CI_PPO.97.5%` > 0) | (`weighted_log_OR_both_ov_CI_PPO.2.5%` < 0 &
                          `weighted_log_OR_both_ov_CI_PPO.97.5%` < 0) , na.rm = T)/
                      sum(!is.na(`weighted_log_OR_both_ov_CI_PPO.2.5%`)), 2),
            Nothing = round(sum((RD_hypox_lower < 0 & RD_hypox_upper < 0) | (RD_hypox_lower > 0 & RD_hypox_upper > 0))/
                                sum(!is.na(RD_hypox_lower)), 2),
            Hypoxemia = round(sum((RD_ED_lower < 0 & RD_ED_upper < 0) | 
                            (RD_ED_lower > 0 & RD_ED_upper > 0) )/
                                sum(!is.na(RD_ED_lower)), 2),
            ED = round(sum((RD_hosp_lower < 0 & RD_hosp_upper < 0) | 
                               (RD_hosp_lower > 0 & RD_hosp_upper > 0))/
                                sum(!is.na(RD_hosp_lower)), 2),
            Hospitalized = round(sum((RD_death_lower < 0 & RD_death_upper < 0) |
                                (RD_death_lower > 0 & RD_death_upper > 0), na.rm = T)/
                                sum(!is.na(RD_death_lower)), 2)
             #Freq_P = round(sum(freq_pval < 0.05)/sum(!is.na(freq_pval)), 3)
            
            ) %>%
  kable(caption = "Power Scenarios Evenly Distributed Outcome", 
      booktabs = T, align = "c", format = "latex") %>%
  kable_paper("hover")   %>% 
  column_spec(1, width = "4em") 


# supplementary table 
results_all_extra %>% mutate_if(is.character, as.numeric) %>% group_by(Scenario) %>%
  dplyr::summarize(
            wOR_sum = round(sum((`weighted_log_OR_bcontrol_CI_PPO.2.5%` > 0 & 
                          `weighted_log_OR_bcontrol_CI_PPO.97.5%` > 0) | (`weighted_log_OR_bcontrol_CI_PPO.2.5%` < 0 &
                          `weighted_log_OR_bcontrol_CI_PPO.97.5%` < 0) , na.rm = T)/
                      sum(!is.na(`weighted_log_OR_bcontrol_CI_PPO.2.5%`)), 2),
            wOR_cumulative = round(sum((`weighted_log_OR_cum_CI_PPO.2.5%` > 0 & 
                          `weighted_log_OR_cum_CI_PPO.97.5%` > 0) | (`weighted_log_OR_cum_CI_PPO.2.5%` < 0 &
                          `weighted_log_OR_cum_CI_PPO.97.5%` < 0) , na.rm = T)/
                      sum(!is.na(`weighted_log_OR_cum_CI_PPO.2.5%`)), 2),
            ARD = round(sum((`unweighted_RD_CI_PPO.2.5%` > 0 & 
                          `unweighted_RD_CI_PPO.97.5%` > 0) | (`unweighted_RD_CI_PPO.2.5%` < 0 & 
                          `unweighted_RD_CI_PPO.97.5%` < 0), na.rm = T)/
                      sum(!is.na(`unweighted_RD_CI_PPO.97.5%`)), 2),
            wRD = round(sum((`weighted_RD_both_CI_PPO.2.5%` > 0 & 
                          `weighted_RD_both_CI_PPO.97.5%` > 0) | (`weighted_RD_both_CI_PPO.2.5%` < 0 & 
                          `weighted_RD_both_CI_PPO.97.5%` < 0), na.rm = T)/
                      sum(!is.na(`weighted_RD_both_CI_PPO.2.5%`)), 2),
            ARR = round(sum((`unweighted_log_RR_CI_PPO.2.5%` > 0 & 
                          `unweighted_log_RR_CI_PPO.97.5%` > 0) | 
                            (`unweighted_log_RR_CI_PPO.2.5%` < 0 & 
                          `unweighted_log_RR_CI_PPO.97.5%` < 0), na.rm = T)/
                      sum(!is.na(`unweighted_log_RR_CI_PPO.2.5%`)), 2),
            wRR = round(sum((`weighted_log_RR_both_CI_PPO.2.5%` > 0 & 
                          `weighted_log_RR_both_CI_PPO.97.5%` > 0) | 
                            `weighted_log_RR_both_CI_PPO.2.5%` < 0 & 
                          `weighted_log_RR_both_CI_PPO.97.5%` < 0, na.rm = T)/
                      sum(!is.na(`weighted_log_RR_both_CI_PPO.2.5%`)), 2),
            ARR_ge = round(sum((`unweighted_log_RR_ge_CI_PPO.2.5%` > 0 & 
                          `unweighted_log_RR_ge_CI_PPO.97.5%` > 0) | 
                            (`unweighted_log_RR_ge_CI_PPO.2.5%` < 0 & 
                          `unweighted_log_RR_ge_CI_PPO.97.5%` < 0), na.rm = T)/
                      sum(!is.na(`unweighted_log_RR_ge_CI_PPO.2.5%`)), 2),
            wRR_ge = round(sum((`weighted_log_RR_ge_both_CI_PPO.2.5%` > 0 & 
                          `weighted_log_RR_ge_both_CI_PPO.97.5%` > 0) | 
                            `weighted_log_RR_ge_both_CI_PPO.2.5%` < 0 & 
                          `weighted_log_RR_ge_both_CI_PPO.97.5%` < 0, na.rm = T)/
                      sum(!is.na(`weighted_log_RR_ge_both_CI_PPO.2.5%`)), 2)
            ) %>%
  kable(caption = "Power Scenarios Evenly Distributed Outcome Supplement", 
      booktabs = T, align = "c", format = "latex") %>%
  kable_paper("hover")   %>% 
  column_spec(1, width = "4em") 
```




\newpage 

\textbf{Simulation setting 10:} Null Effect

pc = pt = c(0.70, 0.18, 0.09, 0.02, 0.01)

\textbf{Simulation setting 11:} Constant Risk Difference Low

pc = c(0.70, 0.18, 0.09, 0.02, 0.01)

pt = c(0.76, 0.18, 0.05, 0.005, 0.005)

\textbf{Simulation setting 12:} Constant Risk Difference High

pc = c(0.70, 0.18, 0.09, 0.02, 0.01)

pt = c(0.78, 0.17, 0.04, 0.005, 0.005)

\textbf{Simulation setting 13:} Constant Relative Risk Low

pc = c(0.70, 0.18, 0.09, 0.02, 0.01)

pt = c(0.77, 0.18, 0.025, 0.0175, 0.0075)

\textbf{Simulation setting 14:} Constant Relative Risk High

pc = c(0.70, 0.18, 0.09, 0.02, 0.01)

pt = c(0.78, 0.185, 0.025, 0.0075, 0.0025)


\textbf{Simulation setting 15:} Low Proportional Odds 

pc = c(0.70, 0.18, 0.09, 0.02, 0.01)

pt = c(0.774, 0.141, 0.064, 0.014, 0.007)

beta = 0.385


\textbf{Simulation setting 16:} High Proportional Odds 

pc = c(0.70, 0.18, 0.09, 0.02, 0.01)

pt = c(0.789, 0.132, 0.0596, 0.0127, 0.006)

beta = 0.47

\textbf{Simulation setting 17:} 50% Reduction in 3-5, Rest to 1

pc = c(0.70, 0.18, 0.09, 0.02, 0.01)

pt = c(0.772, 0.18, 0.036, 0.008, 0.004)

\textbf{Simulation setting 18:} 75% Reduction in 3-5, Rest to 2

pc = c(0.70, 0.18, 0.09, 0.02, 0.01)

pt = c(0.70, 0.27, 0.0225, 0.0050, 0.0025)

\newpage


```{r, echo = F}
#make plot of the various scenarios

#top left corner - stacked bar chart of the various scenarios 
pc <- c(0.70, 0.18, 0.09, 0.02, 0.01)
pc2 <- pc
pt1 <- pc 
# low constant risk difference
pt2 <- c(0.76, 0.18, 0.05, 0.005, 0.005)
# high constant risk difference 
pt3 <- c(0.78, 0.17, 0.04, 0.005, 0.005)
# high RR 
pt4 <- c(0.77, 0.18, 0.025, 0.0175, 0.0075)
# low RR
pt5 <- c(0.78, 0.185, 0.025, 0.0075, 0.0025)
# low PO
beta1_2 <- log(1.47)
pt6 <- c(invlogit(logit(pc2[1]) + beta1_2),
                     invlogit(logit(pc2[1] + pc2[2]) + beta1_2) - invlogit(logit(pc2[1]) + beta1_2),
                     invlogit(logit(pc2[1] + pc2[2] + pc2[3]) + beta1_2) - invlogit(logit(pc2[1] + pc2[2]) + beta1_2),
                     invlogit(logit(pc2[1] + pc2[2] + pc2[3] + pc2[4]) + beta1_2) - 
                          invlogit(logit(pc2[1] + pc2[2] + pc2[3]) + beta1_2),
                     1 - invlogit(logit(pc2[1] + pc2[2] + pc2[3] + pc2[4]) + beta1_2))

# high PO 
beta2_2 <- log(1.60)
pt7 <- c(invlogit(logit(pc2[1]) + beta2_2),
                      invlogit(logit(pc2[1] + pc2[2]) + beta2_2) - invlogit(logit(pc2[1]) + beta2_2),
                      invlogit(logit(pc2[1] + pc2[2] + pc2[3]) + beta2_2) - invlogit(logit(pc2[1] + pc2[2]) + beta2_2),
                      invlogit(logit(pc2[1] + pc2[2] + pc2[3] + pc2[4]) + beta2_2) - 
                          invlogit(logit(pc2[1] + pc2[2] + pc2[3]) + beta2_2),
                      1 - invlogit(logit(pc2[1] + pc2[2] + pc2[3] + pc2[4]) + beta2_2))
# 20% red in last 3, rest to 1 
pt8 <- c(0.772, 0.18, 0.036, 0.008, 0.004)
# 25% red in last 3, rest to 2
pt9 <- c(0.70, 0.27, 0.0225, 0.0050, 0.0025)

scenarios1 <- as.data.frame(rbind(pc, pt1, pt2, pt3, pt4, pt5, pt6, pt7, pt8, pt9))
colnames(scenarios1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
scenarios1$Scenario <- c("Control", "Null", "NP 1", "NP 2", "NP 3", "NP 4", 
                                                "Low PO", "High PO", "NP 5", "NP 6")


p1 <- scenarios1  %>%
  mutate(Scenario = factor(Scenario, levels = c("Control", "Null", 
                                                "Low PO", "High PO", "NP 1", "NP 2",
                                                "NP 3", "NP 4", "NP 5", "NP 6"))) %>% 
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "Proportion") %>% 
  mutate(Outcome = factor(Outcome, levels = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"))) %>%
  ggplot(aes(x = Scenario, y = Proportion, fill = Outcome)) + geom_bar(stat = "identity") + 
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme_bw(base_size = 10) + scale_fill_brewer(palette = "Blues") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14)) 

rd1 <- cumsum(pt1) - cumsum(pc)
rd2 <- cumsum(pt2) - cumsum(pc)
rd3 <- cumsum(pt3) - cumsum(pc)
rd4 <- cumsum(pt4) - cumsum(pc) 
rd5 <- cumsum(pt5) - cumsum(pc) 
rd6 <- cumsum(pt6) - cumsum(pc) 
rd7 <- cumsum(pt7) - cumsum(pc) 
rd8 <- cumsum(pt8) - cumsum(pc) 
rd9 <- cumsum(pt9) - cumsum(pc) 

risk_dif1 <- as.data.frame(rbind(rd1, rd2, rd3, rd4, rd5, rd6, rd7, rd8, rd9))
colnames(risk_dif1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
risk_dif1$Scenario <- c("Null", "NP 1", "NP 2", "NP 3", "NP 4", 
                                                "Low PO", "High PO", "NP 5", "NP 6")

scaleFUN <- function(x) sprintf("%.2f", x)

p2 <- risk_dif1 %>% filter(Scenario != "Null") %>%
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "RD") %>% 
  filter(Outcome != "Death") %>%
  mutate(Outcome = factor(Outcome, levels = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization")),
         Scenario = factor(Scenario, levels = c("Low PO", "High PO", "NP 1", "NP 2", 
                                                "NP 3", "NP 4", "NP 5", "NP 6")))  %>%
  group_by(Scenario) %>%
  ggplot(aes(x = Outcome, y = RD, color = Scenario, group = Scenario, linetype = Scenario)) + 
  geom_line(linewidth = 1) + geom_point(show.legend = F) +
  theme_bw(base_size = 10) + ylab("Cumulative Risk Difference") + 
  scale_linetype_manual(values = c(rep(c("longdash", "solid"), 4))) +
  scale_color_manual(values = c(rep(brewer.pal(8, "Paired")[2], 2), 
                                rep(brewer.pal(8, "Paired")[4], 2), rep(brewer.pal(8, "Paired")[6], 2),
                                rep(brewer.pal(8, "Paired")[8], 2)))  + scale_y_continuous(labels=scaleFUN)  + 
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14)) + 
  scale_x_discrete(labels = c("Nothing" = "1|2",
                              "Hypoxemia" = "2|3", 
                              "ED Visit" = "3|4", 
                              "Hopsitalization" = "4|5"))

#c(brewer.pal(10, "Paired")[10], brewer.pal(8, "Paired")))


rr1 <- cumsum(pt1) / cumsum(pc)
rr2 <- cumsum(pt2) / cumsum(pc)
rr3 <- cumsum(pt3) / cumsum(pc)
rr4 <- cumsum(pt4) / cumsum(pc)
rr5 <- cumsum(pt5) / cumsum(pc) 
rr6 <- cumsum(pt6) / cumsum(pc) 
rr7 <- cumsum(pt7) / cumsum(pc) 
rr8 <- cumsum(pt8) / cumsum(pc) 
rr9 <- cumsum(pt9) / cumsum(pc)

rel_risk1 <- as.data.frame(rbind(rr1, rr2, rr3, rr4, rr5, rr6, rr7, rr8, rr9))
colnames(rel_risk1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
rel_risk1$Scenario <-c("Null", "NP 1", "NP 2", "NP 3", "NP 4", 
                                                "Low PO", "High PO", "NP 5", "NP 6")

p3 <- rel_risk1 %>% filter(Scenario != "Null") %>%
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "RR") %>% 
  filter(Outcome != "Death")  %>%
  mutate(Outcome = factor(Outcome, levels = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization")),
         Scenario = factor(Scenario, levels = c("Low PO", "High PO", "NP 1", "NP 2", 
                                                "NP 3", "NP 4", "NP 5", "NP 6")))  %>%
  group_by(Scenario) %>% 
  ggplot(aes(x = Outcome, y = RR, color = Scenario, group = Scenario, linetype = Scenario)) + 
  geom_line(linewidth = 1) + geom_point(show.legend = F) +
  theme_bw(base_size = 10) + ylab("Cumulative Relative Risk") + 
  scale_linetype_manual(values = c(rep(c("longdash", "solid"), 4))) +
  scale_color_manual(values = c(rep(brewer.pal(8, "Paired")[2], 2), 
                                rep(brewer.pal(8, "Paired")[4], 2), rep(brewer.pal(8, "Paired")[6], 2),
                                rep(brewer.pal(8, "Paired")[8], 2)))  + 
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14)) + 
  scale_x_discrete(labels = c("Nothing" = "\u2264 1",
                              "Hypoxemia" = "\u2264 2", 
                              "ED Visit" = "\u2264 3", 
                              "Hopsitalization" = "\u2264 4"))

#rr greater than or equal to 
rr1 <- revcumsum(pc) / revcumsum(pt1)
rr2 <- revcumsum(pc) / revcumsum(pt2)
rr3 <- revcumsum(pc) / revcumsum(pt3)
rr4 <- revcumsum(pc) / revcumsum(pt4)
rr5 <- revcumsum(pc) / revcumsum(pt5)
rr6 <- revcumsum(pc) / revcumsum(pt6) 
rr7 <- revcumsum(pc) / revcumsum(pt7)
rr8 <- revcumsum(pc) / revcumsum(pt8) 
rr9 <- revcumsum(pc) / revcumsum(pt9)

rel_risk1 <- as.data.frame(rbind(rr1, rr2, rr3, rr4, rr5, rr6, rr7, rr8, rr9))
colnames(rel_risk1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
rel_risk1$Scenario <- c("Null", "Low RD", "High RD", "Low RR", "High RR", "Low PO", "High PO", 
                         "NP 1", "NP 2")

p3ge <- rel_risk1 %>% filter(Scenario != "Null") %>%
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "RR") %>% 
  filter(Outcome != "Nothing")  %>%
  mutate(Outcome = factor(Outcome, levels = c("Hypoxemia", "ED Visit", "Hopsitalization", "Death")),
         Scenario = factor(Scenario, levels = c("Low PO", "High PO", "Low RD", "High RD", 
                                                "Low RR", "High RR", 
                                                "NP 1", "NP 2")))  %>%
  group_by(Scenario) %>% 
  ggplot(aes(x = Outcome, y = RR, color = Scenario, group = Scenario, linetype = Scenario)) + 
  geom_line(linewidth = 1) + geom_point(show.legend = F) +
  theme_bw(base_size = 10) + ylab("Cumulative Relative Risk") + 
  scale_linetype_manual(values = c(rep(c("longdash", "solid"), 4))) +
  scale_color_manual(values = c(rep(brewer.pal(8, "Paired")[2], 2), 
                                rep(brewer.pal(8, "Paired")[4], 2), rep(brewer.pal(8, "Paired")[6], 2),
                                rep(brewer.pal(8, "Paired")[8], 2))) + 
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14)) + 
  scale_x_discrete(labels = c("Hypoxemia" = "\u2265 2", 
                              "ED Visit" = "\u2265 3", 
                              "Hopsitalization" = "\u2265 4", 
                              "Death" = "\u2265 5"))



or1 <- (cumsum(pt1)/ (1- cumsum(pt1))) / (cumsum(pc) / (1 - cumsum(pc)))
or2 <- (cumsum(pt2)/ (1- cumsum(pt2))) / (cumsum(pc) / (1 - cumsum(pc)))
or3 <- (cumsum(pt3)/ (1- cumsum(pt3))) / (cumsum(pc) / (1 - cumsum(pc)))
or4 <- (cumsum(pt4)/ (1- cumsum(pt4))) / (cumsum(pc) / (1 - cumsum(pc)))
or5 <- (cumsum(pt5)/ (1- cumsum(pt5))) / (cumsum(pc) / (1 - cumsum(pc)))
or6 <- (cumsum(pt6)/ (1- cumsum(pt6))) / (cumsum(pc) / (1 - cumsum(pc)))
or7 <- (cumsum(pt7)/ (1- cumsum(pt7))) / (cumsum(pc) / (1 - cumsum(pc)))
or8 <- (cumsum(pt8)/ (1- cumsum(pt8))) / (cumsum(pc) / (1 - cumsum(pc)))
or9 <- (cumsum(pt9)/ (1- cumsum(pt9))) / (cumsum(pc) / (1 - cumsum(pc)))

odds_ratio1 <- as.data.frame(rbind(or1, or2, or3, or4, or5, or6, or7, or8, or9))
colnames(odds_ratio1) <- c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death")
odds_ratio1$Scenario <- c("Null", "NP 1", "NP 2", "NP 3", "NP 4", 
                                                "Low PO", "High PO", "NP 5", "NP 6")

p4 <- odds_ratio1 %>% filter(Scenario != "Null") %>%
  pivot_longer(cols = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization", "Death"), 
               names_to = "Outcome", values_to = "OR") %>% 
  filter(Outcome != "Death") %>%
  mutate(Outcome = factor(Outcome, levels = c("Nothing", "Hypoxemia", "ED Visit", "Hopsitalization")),
         Scenario = factor(Scenario, levels = c("Low PO", "High PO", "NP 1", "NP 2", 
                                                "NP 3", "NP 4", "NP 5", "NP 6")))  %>%
  group_by(Scenario) %>%
  ggplot(aes(x = Outcome, y = OR, color = Scenario, group = Scenario, linetype = Scenario)) +
  geom_line(linewidth = 1) + geom_point(show.legend = F) +
  theme_bw(base_size = 10) + ylab("Cumulative Odds Ratio") + 
  scale_linetype_manual(values = c(rep(c("longdash", "solid"), 4))) +
  scale_color_manual(values = c(rep(brewer.pal(8, "Paired")[2], 2), 
                                rep(brewer.pal(8, "Paired")[4], 2), rep(brewer.pal(8, "Paired")[6], 2),
                                rep(brewer.pal(8, "Paired")[8], 2)))  + 
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 14), legend.text = element_text(size = 9),
        legend.title = element_text(size = 14), 
        strip.text.x = element_text(size = 14)) + 
  scale_x_discrete(labels = c("Nothing" = "1|2",
                              "Hypoxemia" = "2|3", 
                              "ED Visit" = "3|4", 
                              "Hopsitalization" = "4|5"))

legend <- get_legend(
  # create some space to the left of the legend
  p2 + theme(legend.key.size=unit(2.5,"lines")))

library(cowplot)
plots <- plot_grid(p4+ theme(legend.position="none"), p2+ theme(legend.position="none"), 
                   p3+ theme(legend.position="none"),
                   p3ge + theme(legend.position = "none"), labels = c("A", "B", "C", "D"))

plot_grid(plots, legend, rel_widths = c(3, 0.5))

#correct plot to save
#ggsave("covid_out_scenarios_040725.png", height = 8, width = 8, dpi = 600)


# plot to save for supplement showing distributions 

plots <- plot_grid(p1_even + theme(legend.position = "none"), p1+ theme(legend.position = "none"),
          labels = c("A", "B"))
legend <- get_legend(
  # create some space to the left of the legend
  p1_even)
plot_grid(plots, legend, rel_widths = c(3, 0.5))

#ggsave("scenario_distributions_040725.png", height = 6, width = 9, dpi = 600)

```

```{r, echo = F}
setwd("~/Documents/Dissertation/Paper 1/Simulation_040725/")

results1 <- rbind(as.data.frame(readRDS("results_array_040725_19.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_20.rds"))[1:1000,])
results1$Scenario <- "Null"
results2 <- rbind(as.data.frame(readRDS("results_array_040725_21.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_22.rds"))[1:1000,])
results2$Scenario <- "NP 1"
results3 <- rbind(as.data.frame(readRDS("results_array_040725_23.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_24.rds"))[1:1000,])
results3$Scenario <- "NP 2"
results4 <- rbind(as.data.frame(readRDS("results_array_040725_27.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_28.rds"))[1:1000,])
results4$Scenario <- "NP 3"
results5 <- rbind(as.data.frame(readRDS("results_array_040725_25.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_26.rds"))[1:1000,])
results5$Scenario <- "NP 4"
results6 <- rbind(as.data.frame(readRDS("results_array_040725_29.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_30.rds"))[1:1000,])
results6$Scenario <- "Low PO"
results7 <- rbind(as.data.frame(readRDS("results_array_040725_31.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_32.rds"))[1:1000,])
results7$Scenario <- "High PO"
results8 <- rbind(as.data.frame(readRDS("results_array_040725_33.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_34.rds"))[1:1000,])
results8$Scenario <- "NP 5"
results9 <- rbind(as.data.frame(readRDS("results_array_040725_35.rds"))[1:1000,],
                  as.data.frame(readRDS("results_array_040725_36.rds"))[1:1000,])
results9$Scenario <- "NP 6"
```






```{r, echo = F}
# for paper 
results_all <- rbind(results1, results2, results3, results4, results5, results6, results7, results8, results9)

results_all$Scenario <- factor(results_all$Scenario, levels = c("Null", "NP 1", "NP 2",
                                                                "NP 3", "NP 4",
                                                                "Low PO", "High PO", "NP 5",
                                                                "NP 6"))

results_all_extra <- results_all %>% separate(Frequentist_NB_CI, c("Freq_NB_Lower", "Freq_NB_Upper"), ";") 
results_all_extra$Freq_NB_Lower <- gsub("\\[", "", results_all_extra$Freq_NB_Lower)
results_all_extra$Freq_NB_Upper <- gsub("\\]", "", results_all_extra$Freq_NB_Upper)

results_all_extra %>% mutate_if(is.character, as.numeric) %>% group_by(Scenario) %>%
  dplyr::summarize(PO = round(sum((OR_CI_PO1 > 1 & 
                          OR_CI_PO2 > 1) |  (OR_CI_PO1 < 1 & 
                          OR_CI_PO2 < 1), na.rm = T)/
                      sum(!is.na(OR_CI_PO1)), 2),
            NB = round(sum((Freq_NB_Lower > 0 & Freq_NB_Upper > 0) | (Freq_NB_Lower < 0 & Freq_NB_Upper < 0))/
                                    sum(!is.na(Freq_NB_Lower)), 2),
            AOR = round(sum((`unweighted_OR_CI_PPO.2.5%` > 1 & 
                          `unweighted_OR_CI_PPO.97.5%` > 1) | (`unweighted_OR_CI_PPO.2.5%` < 1 & 
                          `unweighted_OR_CI_PPO.97.5%` < 1), na.rm = T)/
                      sum(!is.na(`unweighted_OR_CI_PPO.2.5%`)), 2),
            wOR = round(sum((`weighted_log_OR_both_CI_PPO.2.5%` > 0 & 
                          `weighted_log_OR_both_CI_PPO.97.5%` > 0) | (`weighted_log_OR_both_CI_PPO.2.5%` < 0 &
                          `weighted_log_OR_both_CI_PPO.97.5%` < 0) , na.rm = T)/
                      sum(!is.na(`weighted_log_OR_both_CI_PPO.2.5%`)), 2),
            wOR_overall = round(sum((`weighted_log_OR_both_ov_CI_PPO.2.5%` > 0 & 
                          `weighted_log_OR_both_ov_CI_PPO.97.5%` > 0) | (`weighted_log_OR_both_ov_CI_PPO.2.5%` < 0 &
                          `weighted_log_OR_both_ov_CI_PPO.97.5%` < 0) , na.rm = T)/
                      sum(!is.na(`weighted_log_OR_both_ov_CI_PPO.2.5%`)), 2),
            Nothing = round(sum((RD_hypox_lower < 0 & RD_hypox_upper < 0) | (RD_hypox_lower > 0 & RD_hypox_upper > 0))/
                                sum(!is.na(RD_hypox_lower)), 2),
            Hypoxemia = round(sum((RD_ED_lower < 0 & RD_ED_upper < 0) | 
                            (RD_ED_lower > 0 & RD_ED_upper > 0) )/
                                sum(!is.na(RD_ED_lower)), 2),
            ED = round(sum((RD_hosp_lower < 0 & RD_hosp_upper < 0) | 
                               (RD_hosp_lower > 0 & RD_hosp_upper > 0), na.rm = T)/
                                sum(!is.na(RD_hosp_lower)), 2),
            Hospitalized = round(sum((RD_death_lower < 0 & RD_death_upper < 0) |
                                (RD_death_lower > 0 & RD_death_upper > 0), na.rm = T)/
                                sum(!is.na(RD_death_lower)), 2)
           # Freq = round(sum(freq_pval < 0.05)/sum(!is.na(freq_pval)), 3)
            
            ) %>%
  kable(caption = "Power Scenarios Mimicking COVID-OUT", 
      booktabs = T, align = "c", format = "latex") %>%
  kable_paper("hover") 


# Supplement Table

results_all_extra %>% mutate_if(is.character, as.numeric) %>% group_by(Scenario) %>%
  dplyr::summarize(
            wOR_sum = round(sum((`weighted_log_OR_bcontrol_CI_PPO.2.5%` > 0 & 
                          `weighted_log_OR_bcontrol_CI_PPO.97.5%` > 0) | (`weighted_log_OR_bcontrol_CI_PPO.2.5%` < 0 &
                          `weighted_log_OR_bcontrol_CI_PPO.97.5%` < 0) , na.rm = T)/
                      sum(!is.na(`weighted_log_OR_bcontrol_CI_PPO.2.5%`)), 2),
            wOR_cumulative = round(sum((`weighted_log_OR_cum_CI_PPO.2.5%` > 0 & 
                          `weighted_log_OR_cum_CI_PPO.97.5%` > 0) | (`weighted_log_OR_cum_CI_PPO.2.5%` < 0 &
                          `weighted_log_OR_cum_CI_PPO.97.5%` < 0) , na.rm = T)/
                      sum(!is.na(`weighted_log_OR_cum_CI_PPO.2.5%`)), 2),
            ARD = round(sum((`unweighted_RD_CI_PPO.2.5%` > 0 & 
                          `unweighted_RD_CI_PPO.97.5%` > 0) | (`unweighted_RD_CI_PPO.2.5%` < 0 & 
                          `unweighted_RD_CI_PPO.97.5%` < 0), na.rm = T)/
                      sum(!is.na(`unweighted_RD_CI_PPO.97.5%`)), 2),
            wRD = round(sum((`weighted_RD_both_CI_PPO.2.5%` > 0 & 
                          `weighted_RD_both_CI_PPO.97.5%` > 0) | (`weighted_RD_both_CI_PPO.2.5%` < 0 & 
                          `weighted_RD_both_CI_PPO.97.5%` < 0), na.rm = T)/
                      sum(!is.na(`weighted_RD_both_CI_PPO.2.5%`)), 2),
            ARR_le = round(sum((`unweighted_log_RR_CI_PPO.2.5%` > 0 & 
                          `unweighted_log_RR_CI_PPO.97.5%` > 0) | 
                            (`unweighted_log_RR_CI_PPO.2.5%` < 0 & 
                          `unweighted_log_RR_CI_PPO.97.5%` < 0), na.rm = T)/
                      sum(!is.na(`unweighted_log_RR_CI_PPO.2.5%`)), 2),
            wRR_le = round(sum((`weighted_log_RR_both_CI_PPO.2.5%` > 0 & 
                          `weighted_log_RR_both_CI_PPO.97.5%` > 0) | 
                            `weighted_log_RR_both_CI_PPO.2.5%` < 0 & 
                          `weighted_log_RR_both_CI_PPO.97.5%` < 0, na.rm = T)/
                      sum(!is.na(`weighted_log_RR_both_CI_PPO.2.5%`)), 2),
            ARR_ge = round(sum((`unweighted_log_RR_ge_CI_PPO.2.5%` > 0 & 
                          `unweighted_log_RR_ge_CI_PPO.97.5%` > 0) | 
                            (`unweighted_log_RR_ge_CI_PPO.2.5%` < 0 & 
                          `unweighted_log_RR_ge_CI_PPO.97.5%` < 0), na.rm = T)/
                      sum(!is.na(`unweighted_log_RR_ge_CI_PPO.2.5%`)), 2),
            wRR_ge = round(sum((`weighted_log_RR_ge_both_CI_PPO.2.5%` > 0 & 
                          `weighted_log_RR_ge_both_CI_PPO.97.5%` > 0) | 
                            `weighted_log_RR_ge_both_CI_PPO.2.5%` < 0 & 
                          `weighted_log_RR_ge_both_CI_PPO.97.5%` < 0, na.rm = T)/
                      sum(!is.na(`weighted_log_RR_ge_both_CI_PPO.2.5%`)), 2)
            ) %>%
  kable(caption = "Power Scenarios Mimicking COVID-OUT Supplement", 
      booktabs = T, align = "c", format = "latex") %>%
  kable_paper("hover") 

```

